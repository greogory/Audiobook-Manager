#!/bin/bash
# =============================================================================
# Audiobook Metadata Copier
# =============================================================================
# Copy companion files (chapters, metadata) to converted audiobook directories
# Matches files intelligently and copies chapters.json, cover art, PDFs, etc.
# =============================================================================

# Load configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [[ -f "${SCRIPT_DIR}/../lib/audiobook-config.sh" ]]; then
    source "${SCRIPT_DIR}/../lib/audiobook-config.sh"
elif [[ -f "/opt/audiobooks/lib/audiobook-config.sh" ]]; then
    source "/opt/audiobooks/lib/audiobook-config.sh"
elif [[ -f "/usr/local/lib/audiobooks/audiobook-config.sh" ]]; then
    source "/usr/local/lib/audiobooks/audiobook-config.sh"
else
    echo "ERROR: Cannot find audiobook-config.sh" >&2
    exit 1
fi

# Configuration
SOURCES_DIR="${AUDIOBOOKS_SOURCES}"
LIBRARY_DIR="${AUDIOBOOKS_LIBRARY}"
LOG_DIR="${AUDIOBOOKS_LOGS}"
LOG_FILE="${LOG_DIR}/metadata_copy.log"

mkdir -p "$LOG_DIR"

# Color codes
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "=========================================" | tee "$LOG_FILE"
echo -e "${CYAN}AUDIOBOOK METADATA COPIER${NC}" | tee -a "$LOG_FILE"
echo "=========================================" | tee -a "$LOG_FILE"
date | tee -a "$LOG_FILE"
echo "" | tee -a "$LOG_FILE"

# Find all audiobook directories in library
COPIED=0
SKIPPED=0

while IFS= read -r AUDIOBOOK_DIR; do
    # Get the audiobook name from directory
    BOOK_NAME=$(basename "$AUDIOBOOK_DIR")
    AUTHOR_DIR=$(dirname "$AUDIOBOOK_DIR")
    AUTHOR_NAME=$(basename "$AUTHOR_DIR")

    # Try to find matching source files
    # First try to find by ASIN in the opus filename
    OPUS_FILE=$(find "$AUDIOBOOK_DIR" -name "*.opus" -type f ! -name "*.cover.opus" 2>/dev/null | head -1)

    if [ -z "$OPUS_FILE" ]; then
        continue
    fi

    OPUS_BASENAME=$(basename "$OPUS_FILE" .opus)

    # Convert spaces and colons to underscores for matching source filenames
    OPUS_SEARCH=$(echo "$OPUS_BASENAME" | tr ' :' '_' | tr -s '_')

    # Look for chapters.json file - try multiple matching strategies
    # 1. Direct match with underscores
    # 2. Fuzzy match on first few words
    # NO fallback to any chapters.json - that causes wrong file matching!
    CHAPTERS_FILE=""

    # Try direct match first (underscores)
    CHAPTERS_FILE=$(find "$SOURCES_DIR" -name "*${OPUS_SEARCH}*-chapters.json" 2>/dev/null | head -1)

    # If not found, try first 3 words (handles subtitle differences)
    if [ -z "$CHAPTERS_FILE" ]; then
        FIRST_WORDS=$(echo "$OPUS_SEARCH" | cut -d'_' -f1-3)
        if [ -n "$FIRST_WORDS" ]; then
            CHAPTERS_FILE=$(find "$SOURCES_DIR" -name "*${FIRST_WORDS}*-chapters.json" 2>/dev/null | head -1)
        fi
    fi

    if [ -n "$CHAPTERS_FILE" ] && [ ! -f "$AUDIOBOOK_DIR/chapters.json" ]; then
        # Verify the file isn't the wrong book by checking it has content
        if [ -s "$CHAPTERS_FILE" ]; then
            cp "$CHAPTERS_FILE" "$AUDIOBOOK_DIR/chapters.json"
            echo -e "${GREEN}✓${NC} Copied chapters: $BOOK_NAME" | tee -a "$LOG_FILE"
            ((COPIED++))
        fi
    fi

    # Look for cover art - also use underscore matching
    COVER_FILE=$(find "$SOURCES_DIR" -name "*${OPUS_SEARCH}*.jpg" -o -name "*${OPUS_SEARCH}*.png" 2>/dev/null | head -1)

    if [ -n "$COVER_FILE" ] && [ ! -f "$AUDIOBOOK_DIR/cover.jpg" ]; then
        cp "$COVER_FILE" "$AUDIOBOOK_DIR/cover.jpg"
        echo -e "${GREEN}✓${NC} Copied cover: $BOOK_NAME" | tee -a "$LOG_FILE"
        ((COPIED++))
    fi

done < <(find "$LIBRARY_DIR" -mindepth 2 -maxdepth 2 -type d 2>/dev/null)

echo "" | tee -a "$LOG_FILE"
echo "=========================================" | tee -a "$LOG_FILE"
echo "Copied: $COPIED files" | tee -a "$LOG_FILE"
echo "=========================================" | tee -a "$LOG_FILE"
